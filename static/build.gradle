apply plugin: 'java'

dependencies {
    compile 'org.jruby:jruby-complete:1.6.7.2'
    compile 'org.rubygems:jruby-openssl:0.7.7'
    compile 'org.rubygems:haml:3.1.6'
}

configurations {
    staticContent
}

artifacts {
    fileTree(dir: "$buildDir/static/", include: "*.html").each { file ->
        staticContent file
    }
}

def filename(file) {
    file.name.substring(0, file.name.lastIndexOf("."))
}

fileTree(dir: 'src/main/resources', include: '*.haml').each { file ->
    task("haml-${filename(file)}", type: JavaExec) {
        main 'org.jruby.Main'
        classpath runtimeClasspath
        args 'classpath:bin/haml', '--trace', file.canonicalPath, "$buildDir/static/${filename(file)}.html"
    }

    tasks.build.dependsOn << "haml-${filename(file)}"
}

processResources << {
    file("$buildDir/static").mkdirs()
}
